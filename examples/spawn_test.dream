// Test spawn and receive

mod spawn_test {
    pub fn simple() -> int {
        3
    }

    pub fn get_self() -> pid {
        self()
    }

    // Spawn a process that runs a function
    pub fn test_spawn() -> pid {
        spawn(simple())
    }

    // Test spawning with closure
    pub fn spawn_adder() -> pid {
        let x = 10;
        spawn(add(x, 5))
    }

    fn add(a: int, b: int) -> int {
        a + b
    }

    // Wait for any message and return it
    pub fn wait() -> int {
        receive {
            x => x
        }
    }

    // Selective receive - only accept :ok messages
    pub fn wait_ok() -> atom {
        receive {
            :ok => :ok
        }
    }

    // Echo server: receive a message and send it back
    pub fn echo_once(reply_to: pid) -> atom {
        let msg = receive {
            m => m
        };
        reply_to <- msg;
        :done
    }

    // Receive with timeout - returns :timeout if no message within 100ms
    pub fn wait_timeout() -> atom {
        receive {
            _ => :got_msg,
            after 100 => {
                :timeout
            }
        }
    }

    // Receive with longer timeout
    pub fn wait_with_timeout(ms: int) -> atom {
        receive {
            :ping => :pong,
            _ => :other,
            after ms => {
                :timed_out
            }
        }
    }
}

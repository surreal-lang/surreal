// Tests for http_api
// Only compiled when running `dream test`

use crate::models::user::User;

#[test]
pub fn test_user_serialize() -> Atom {
    // Test cross-module method call with Serialize trait
    let user = User { id: 42, name: "Alice" };
    let json = user.serialize();

    // Check that the map has the correct keys and values
    let id = :maps::get(:id, json);
    let name = :maps::get(:name, json);

    if id != 42 {
        :erlang::error((:wrong_id, id))
    } else {
        if name != "Alice" {
            :erlang::error((:wrong_name, name))
        } else {
            :ok
        }
    }
}

#[test]
pub fn test_map_to_json_compatible() -> Atom {
    // Test that serialize returns a map compatible with JSON encoding
    let user = User { id: 1, name: "Bob" };
    let map = user.serialize();

    // Verify the map has the expected structure
    let has_id = :maps::is_key(:id, map);
    let has_name = :maps::is_key(:name, map);

    if has_id && has_name {
        :ok
    } else {
        :erlang::error(:missing_keys)
    }
}

#[test]
pub fn test_addition() -> Atom {
    let result = 1 + 1;
    if result != 2 {
        :erlang::error(:assertion_failed)
    } else {
        :ok
    }
}

#[test]
pub fn test_list_operations() -> Atom {
    let list = [1, 2, 3];
    let len = :erlang::length(list);
    if len != 3 {
        :erlang::error(:wrong_length)
    } else {
        :ok
    }
}

#[test]
pub fn test_map_operations() -> Atom {
    let map = :maps::new();
    let map = :maps::put(:key, "value", map);
    match :maps::get(:key, map) {
        "value" => :ok,
        _ => :erlang::error(:wrong_value)
    }
}
